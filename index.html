<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halo Media Tool (Vercel Accelerated)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.7/dist/umd/ffmpeg.js"></script>
    <script src="https://unpkg.com/@ffmpeg/util@0.12.1/dist/umd/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: "Microsoft YaHei UI", sans-serif; }
        .main-container { max-width: 980px; margin: 30px auto; background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); overflow: hidden; }
        .header { background: #6f42c1; color: white; padding: 20px; } /* Vercel ç´« */
        .nav-tabs .nav-link { color: #495057; font-weight: 600; padding: 15px 25px; }
        .nav-tabs .nav-link.active { color: #6f42c1; border-bottom: 3px solid #6f42c1; }
        .tab-content { padding: 25px; }
        .drop-zone { border: 2px dashed #adb5bd; background: #f8f9fa; padding: 30px; text-align: center; cursor: pointer; border-radius: 8px; transition: 0.3s; }
        .drop-zone:hover { border-color: #6f42c1; background: #e9ecef; }
        .log-box { background: #212529; color: #00ff00; font-family: Consolas, monospace; font-size: 0.85rem; height: 150px; overflow-y: auto; padding: 10px; border-radius: 6px; margin-top: 15px; }
        .param-group { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #dee2e6; }
    </style>
</head>
<body>

<div class="main-container">
    <div class="header d-flex justify-content-between align-items-center">
        <h4 class="m-0">Halo Media Tool <span class="badge bg-light text-dark" style="font-size:0.6em">Multi-Threaded</span></h4>
        <small>Powered by Vercel</small>
    </div>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#img-pane">ğŸ–¼ï¸ å›¾ç‰‡å‹ç¼©</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#video-pane">ğŸ¬ è§†é¢‘å‹ç¼©</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="img-pane">
            <div class="row">
                <div class="col-md-5">
                    <div class="param-group">
                        <label class="form-label fw-bold">å›¾ç‰‡å‚æ•°</label>
                        <div class="mb-3"><label>è´¨é‡ (5-100)</label><div class="d-flex"><input type="range" class="form-range flex-grow-1" id="img-quality" min="5" max="100" value="75"><span class="badge bg-secondary ms-2" id="img-val">75</span></div></div>
                        <div class="mb-3"><label>æœ€å¤§å®½åº¦</label><input type="number" class="form-control" id="img-width" value="0" placeholder="0=åŸå›¾"></div>
                        <div class="mb-3"><label>æ ¼å¼</label><select class="form-select" id="img-fmt"><option value="image/jpeg">JPEG</option><option value="image/png">PNG</option><option value="image/webp">WEBP</option></select></div>
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="drop-zone" id="img-drop"><h5>ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</h5><input type="file" id="img-in" accept="image/*" multiple style="display:none"></div>
                    <button id="img-btn" class="btn btn-primary w-100 mt-3" disabled>å¼€å§‹å‹ç¼©</button>
                    <div id="img-res" class="mt-3" style="display:none;"><button id="img-dl" class="btn btn-outline-primary w-100">ğŸ“¦ ä¸‹è½½å‹ç¼©åŒ…</button></div>
                </div>
            </div>
            <div class="log-box" id="img-log">å‡†å¤‡å°±ç»ª...</div>
        </div>

        <div class="tab-pane fade" id="video-pane">
            <div class="alert alert-info py-2 small">
                <i class="bi bi-lightning-charge-fill"></i> 
                <strong>æé€Ÿæ¨¡å¼ï¼š</strong> å·²å¯ç”¨å¤šçº¿ç¨‹åŠ é€Ÿã€‚å¦‚æœæ­¤é¡µé¢åœ¨ Vercel ä¸Šè¿è¡Œï¼Œé€Ÿåº¦å°†å¤§å¹…æå‡ã€‚
            </div>
            <div class="drop-zone py-4" id="vid-drop">
                <h5 class="mb-1">ğŸ“‚ ç‚¹å‡»é€‰æ‹©è§†é¢‘</h5>
                <p class="text-muted small mb-0" id="vid-lbl">æœªé€‰æ‹©æ–‡ä»¶</p>
                <input type="file" id="vid-in" accept="video/*" style="display:none">
            </div>
            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="param-group">
                        <label class="fw-bold">æ¨¡å¼</label>
                        <select class="form-select mb-2" id="vid-mode"><option value="crf">CRF ç”»è´¨ä¼˜å…ˆ</option><option value="target">ç›®æ ‡å¤§å°ä¼˜å…ˆ</option></select>
                        <div id="crf-box"><label>CRF (18-35): <span id="crf-val" class="text-primary fw-bold">28</span></label><input type="range" class="form-range" id="vid-crf" min="18" max="35" value="28"></div>
                        <div id="tgt-box" style="display:none;"><label>ç›®æ ‡MB</label><input type="number" class="form-control" id="vid-tgt" placeholder="å¦‚: 50"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="param-group">
                        <label class="fw-bold">è®¾ç½®</label>
                        <div class="row g-2">
                            <div class="col-6"><label>åˆ†è¾¨ç‡</label><select class="form-select form-select-sm" id="vid-res"><option value="orig">åŸå§‹</option><option value="720p">720p</option><option value="1080p">1080p</option></select></div>
                            <div class="col-6"><label>é¢„è®¾</label><select class="form-select form-select-sm" id="vid-pre"><option value="veryfast" selected>Veryfast</option><option value="ultrafast">Ultrafast</option></select></div>
                            <div class="col-12 mt-2"><label>éŸ³é¢‘(kbps)</label><input type="number" class="form-control form-control-sm" id="vid-aud" value="128"></div>
                        </div>
                    </div>
                </div>
            </div>
            <button id="vid-btn" class="btn btn-primary w-100 py-2" disabled>å¼€å§‹è§†é¢‘å‹ç¼©</button>
            <div class="progress mt-3" style="height: 25px;"><div id="vid-prog" class="progress-bar progress-bar-striped progress-bar-animated bg-success" style="width: 0%">0%</div></div>
            <div class="log-box mt-3" id="vid-log">æ­£åœ¨åŠ è½½å¤šçº¿ç¨‹å¼•æ“...</div>
            <div id="vid-res-area" class="mt-3 text-center" style="display:none;"><p>å®Œæˆ: <span id="vid-saved"></span></p><a id="vid-dl" class="btn btn-success">â¬‡ï¸ ä¸‹è½½è§†é¢‘</a></div>
        </div>
    </div>
</div>

<script>
    // --- å›¾ç‰‡é€»è¾‘ (Canvas) ---
    const I = (id) => document.getElementById(id);
    let imgFs = [], vidF = null, vidMeta = {};
    
    I('img-quality').oninput = (e) => I('img-val').innerText = e.target.value;
    I('img-drop').onclick = () => I('img-in').click();
    I('img-in').onchange = (e) => { imgFs = Array.from(e.target.files); I('img-btn').disabled = !imgFs.length; I('img-btn').innerText = `å¼€å§‹ (${imgFs.length})`; };
    
    I('img-btn').onclick = async () => {
        const zip = new JSZip();
        I('img-btn').disabled = true;
        for(let f of imgFs) {
            I('img-log').innerText = `å¤„ç†: ${f.name}`;
            const blob = await compressImg(f, I('img-quality').value/100, I('img-width').value, I('img-fmt').value);
            zip.file(f.name.split('.')[0] + '_opt.' + (I('img-fmt').value.includes('png')?'png':'jpg'), blob);
        }
        I('img-log').innerText = 'æ‰“åŒ…ä¸­...';
        I('img-dl').onclick = async () => saveAs(await zip.generateAsync({type:"blob"}), "images.zip");
        I('img-res').style.display = 'block'; I('img-btn').disabled = false;
    };

    function compressImg(file, q, w, fmt) {
        return new Promise(r => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = e => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const c = document.createElement('canvas');
                    let rw = img.width, rh = img.height;
                    if(w > 0 && rw > w) { rh = Math.round(rh * (w/rw)); rw = w; }
                    c.width = rw; c.height = rh;
                    c.getContext('2d').drawImage(img,0,0,rw,rh);
                    c.toBlob(r, fmt, q);
                }
            }
        });
    }

    // --- è§†é¢‘é€»è¾‘ (FFmpeg v0.12 Multi-Threaded) ---
    const { FFmpeg } = FFmpegWASM;
    const { fetchFile } = FFmpegUtil;
    const ffmpeg = new FFmpeg();

    const loadFFmpeg = async () => {
        try {
            // åŠ è½½å¤šçº¿ç¨‹æ ¸å¿ƒ
            await ffmpeg.load({
                coreURL: 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.js',
                wasmURL: 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.wasm',
            });
            I('vid-log').innerHTML = "âœ… å¤šçº¿ç¨‹å¼•æ“å°±ç»ª! (è¯·ç¡®ä¿åœ¨ Vercel/Https ç¯å¢ƒ)";
        } catch(e) {
            I('vid-log').innerHTML = "âŒ åŠ è½½å¤±è´¥: " + e.message + "<br>è¯·ç¡®ä¿ä½¿ç”¨äº† vercel.json å¹¶ä¸”ä¸åœ¨æ™®é€š HTTP ç¯å¢ƒä¸‹ã€‚";
        }
    };
    loadFFmpeg();

    ffmpeg.on('log', ({ message }) => { console.log(message); });
    ffmpeg.on('progress', ({ progress }) => {
        const p = Math.round(progress * 100);
        if(p > 0 && p <= 100) I('vid-prog').style.width = p + '%'; I('vid-prog').innerText = p + '%';
    });

    I('vid-drop').onclick = () => I('vid-in').click();
    I('vid-in').onchange = (e) => {
        vidF = e.target.files[0];
        if(!vidF) return;
        I('vid-lbl').innerText = vidF.name;
        const v = document.createElement('video');
        v.src = URL.createObjectURL(vidF);
        v.onloadedmetadata = () => { vidMeta.dur = v.duration; I('vid-btn').disabled = false; };
    };

    I('vid-mode').onchange = (e) => {
        I('crf-box').style.display = e.target.value==='crf'?'block':'none';
        I('tgt-box').style.display = e.target.value==='target'?'block':'none';
    };
    I('vid-crf').oninput = (e) => I('crf-val').innerText = e.target.value;

    I('vid-btn').onclick = async () => {
        if(!vidF) return;
        I('vid-btn').disabled = true; I('vid-res-area').style.display = 'none';
        I('vid-log').innerText = "å†™å…¥å†…å­˜...";
        
        await ffmpeg.writeFile('in.mp4', await fetchFile(vidF));
        
        const mode = I('vid-mode').value;
        let args = ['-i', 'in.mp4', '-c:v', 'libx264', '-preset', I('vid-pre').value];
        
        // é€»è¾‘è½¬æ¢
        if(I('vid-res').value === '720p') args.push('-vf', 'scale=-2:720');
        if(I('vid-res').value === '1080p') args.push('-vf', 'scale=-2:1080');

        if(mode === 'target') {
            const tgt = I('vid-tgt').value;
            const br = Math.floor((tgt * 8388608 / vidMeta.dur) - (I('vid-aud').value*1000));
            args.push('-b:v', (br>100000?br:100000).toString());
        } else {
            args.push('-crf', I('vid-crf').value);
        }
        
        args.push('-c:a', 'aac', '-b:a', I('vid-aud').value+'k', 'out.mp4');
        
        I('vid-log').innerText = "ğŸš€ æ­£åœ¨å…¨åŠ›å‹ç¼© (å¤šæ ¸å¿ƒè¿è¡Œä¸­)...";
        const t1 = Date.now();
        await ffmpeg.exec(args);
        const t2 = Date.now();
        
        I('vid-log').innerText = `âœ… å®Œæˆ! è€—æ—¶: ${((t2-t1)/1000).toFixed(1)}s`;
        
        const data = await ffmpeg.readFile('out.mp4');
        const url = URL.createObjectURL(new Blob([data.buffer], {type: 'video/mp4'}));
        I('vid-dl').href = url; 
        I('vid-dl').download = 'compressed_'+vidF.name;
        I('vid-res-area').style.display = 'block';
        I('vid-btn').disabled = false;
    }
</script>
</body>
</html>
