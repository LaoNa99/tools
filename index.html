<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halo Media Compressor Web v5.0 (Full Port)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        body { background-color: #f0f2f5; font-family: "Microsoft YaHei UI", sans-serif; }
        .main-container { max-width: 980px; margin: 30px auto; background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); overflow: hidden; }
        .header { background: #0d6efd; color: white; padding: 20px; }
        .nav-tabs .nav-link { color: #495057; font-weight: 600; padding: 15px 25px; }
        .nav-tabs .nav-link.active { color: #0d6efd; border-bottom: 3px solid #0d6efd; }
        .tab-content { padding: 25px; }
        
        /* é€šç”¨æ ·å¼ */
        .drop-zone { border: 2px dashed #adb5bd; background: #f8f9fa; padding: 30px; text-align: center; cursor: pointer; border-radius: 8px; transition: 0.3s; }
        .drop-zone:hover { border-color: #0d6efd; background: #e9ecef; }
        .log-box { background: #212529; color: #00ff00; font-family: Consolas, monospace; font-size: 0.85rem; height: 150px; overflow-y: auto; padding: 10px; border-radius: 6px; margin-top: 15px; }
        .param-group { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #dee2e6; }
        .btn-primary { background-color: #0d6efd; }
    </style>
</head>
<body>

<div class="main-container">
    <div class="header d-flex justify-content-between align-items-center">
        <h4 class="m-0">Halo Media Compressor <span class="badge bg-light text-primary" style="font-size:0.6em">Web v5.0</span></h4>
        <small>å¤åˆ»è‡ª Python v4.6</small>
    </div>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="img-tab" data-bs-toggle="tab" data-bs-target="#img-pane" type="button">ğŸ–¼ï¸ å›¾ç‰‡å‹ç¼©</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="video-tab" data-bs-toggle="tab" data-bs-target="#video-pane" type="button">ğŸ¬ è§†é¢‘å‹ç¼©</button>
        </li>
    </ul>

    <div class="tab-content">
        
        <div class="tab-pane fade show active" id="img-pane" role="tabpanel">
            <div class="row">
                <div class="col-md-5">
                    <div class="param-group">
                        <label class="form-label fw-bold">å‹ç¼©å‚æ•°</label>
                        
                        <div class="mb-3">
                            <label class="form-label">å›¾ç‰‡è´¨é‡ (5-100)</label>
                            <div class="d-flex align-items-center">
                                <input type="range" class="form-range flex-grow-1" id="img-quality" min="5" max="100" value="75">
                                <span class="badge bg-primary ms-2" id="img-quality-val">75</span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">æœ€å¤§å®½åº¦ (px, 0=ä¸ç¼©æ”¾)</label>
                            <input type="number" class="form-control" id="img-max-width" value="0" placeholder="ä¾‹å¦‚: 1920">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">è¾“å‡ºæ ¼å¼</label>
                            <select class="form-select" id="img-format">
                                <option value="image/jpeg">JPEG (é»˜è®¤)</option>
                                <option value="image/png">PNG</option>
                                <option value="image/webp">WEBP (æ¨è)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="col-md-7">
                    <div class="drop-zone" id="img-drop-area">
                        <h5>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œ</h5>
                        <p class="text-muted small">æ”¯æŒ JPG, PNG, WEBP (å¯å¤šé€‰)</p>
                        <input type="file" id="img-input" accept="image/*" multiple style="display:none">
                    </div>
                    
                    <div class="mt-3">
                        <button id="img-start-btn" class="btn btn-success w-100" disabled>å¼€å§‹å¤„ç†å›¾ç‰‡</button>
                    </div>

                    <div id="img-result-area" class="mt-3" style="display:none;">
                        <div class="alert alert-success py-2 d-flex justify-content-between align-items-center">
                            <span>å¤„ç†å®Œæˆ: <b id="img-count">0</b> å¼ </span>
                            <button id="img-dl-btn" class="btn btn-sm btn-outline-success" style="background:white;">ğŸ“¦ æ‰“åŒ…ä¸‹è½½ (ZIP)</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="log-box" id="img-log">ç­‰å¾…é€‰æ‹©å›¾ç‰‡...</div>
        </div>


        <div class="tab-pane fade" id="video-pane" role="tabpanel">
            <div class="alert alert-warning py-2 small">
                <i class="bi bi-exclamation-triangle"></i> 
                <strong>æ³¨æ„ï¼š</strong> Webç«¯è§†é¢‘å‹ç¼©å®Œå…¨ä¾èµ–æ‚¨çš„CPUå•æ ¸æ€§èƒ½ã€‚å¤„ç† 1080p è§†é¢‘å¯èƒ½éå¸¸ç¼“æ…¢(çº¦ 0.1å€é€Ÿ)ï¼Œè¯·å‹¿è®¤ä¸ºç¨‹åºæ­»æœºï¼Œè€å¿ƒç­‰å¾…è¿›åº¦æ¡èµ°åŠ¨ã€‚
            </div>

            <div class="drop-zone py-4" id="video-drop-area">
                <h5 class="mb-1">ğŸ“‚ ç‚¹å‡»é€‰æ‹©è§†é¢‘æ–‡ä»¶</h5>
                <p class="text-muted small mb-0" id="video-file-label">æœªé€‰æ‹©æ–‡ä»¶</p>
                <input type="file" id="video-input" accept="video/*" style="display:none">
            </div>

            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="param-group">
                        <label class="form-label fw-bold">æ¨¡å¼é€‰æ‹©</label>
                        <select class="form-select mb-2" id="video-mode">
                            <option value="crf">CRF ç”»è´¨ä¼˜å…ˆ (é»˜è®¤)</option>
                            <option value="target">ç›®æ ‡å¤§å°ä¼˜å…ˆ</option>
                        </select>
                        
                        <div id="video-crf-ctrl">
                            <label class="small text-muted">CRF å€¼ (18-35): <span id="video-crf-val" class="text-primary fw-bold">28</span></label>
                            <input type="range" class="form-range" id="video-crf-slider" min="18" max="35" value="28">
                        </div>

                        <div id="video-target-ctrl" style="display:none;">
                            <label class="small text-muted">ç›®æ ‡å¤§å° (MB)</label>
                            <input type="number" class="form-control" id="video-target-mb" placeholder="ä¾‹å¦‚: 50">
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="param-group">
                        <label class="form-label fw-bold">é«˜çº§è®¾ç½®</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="small text-muted">åˆ†è¾¨ç‡é™åˆ¶</label>
                                <select class="form-select form-select-sm" id="video-res">
                                    <option value="orig">åŸå§‹</option>
                                    <option value="720p">720p</option>
                                    <option value="1080p">1080p</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="small text-muted">é¢„è®¾ (é€Ÿåº¦)</label>
                                <select class="form-select form-select-sm" id="video-preset">
                                    <option value="ultrafast" selected>Ultrafast (æé€Ÿ)</option>
                                    <option value="veryfast">Veryfast (æ¨è)</option>
                                    <option value="medium">Medium (æ…¢)</option>
                                </select>
                            </div>
                            <div class="col-12 mt-2">
                                <label class="small text-muted">éŸ³é¢‘ç ç‡ (kbps)</label>
                                <input type="number" class="form-control form-control-sm" id="video-audio" value="128">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <button id="video-start-btn" class="btn btn-success w-100 py-2" disabled>å¼€å§‹è§†é¢‘å‹ç¼©</button>
            
            <div class="progress mt-3" style="height: 25px;">
                <div id="video-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-info" style="width: 0%">0%</div>
            </div>

            <div class="log-box mt-3" id="video-log">ç³»ç»Ÿæ­£åœ¨åˆå§‹åŒ–æ ¸å¿ƒ (v0.11)...</div>

            <div id="video-result-area" class="mt-3 text-center" style="display:none;">
                <h5 class="text-success">âœ… è§†é¢‘å‹ç¼©å®Œæˆ</h5>
                <p>åŸå§‹: <span id="vid-orig-size"></span> -> å‹ç¼©å: <span id="vid-new-size"></span></p>
                <a id="video-dl-link" class="btn btn-primary">â¬‡ï¸ ä¸‹è½½è§†é¢‘</a>
            </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ================== å›¾ç‰‡å¤„ç†é€»è¾‘ (Native JS) ==================
    const imgInput = document.getElementById('img-input');
    const imgDrop = document.getElementById('img-drop-area');
    const imgStartBtn = document.getElementById('img-start-btn');
    const imgLog = document.getElementById('img-log');
    const imgQuality = document.getElementById('img-quality');
    const imgQualityVal = document.getElementById('img-quality-val');
    
    let imgFiles = [];
    let processedImages = []; // å­˜å‚¨å¤„ç†åçš„ blob

    imgQuality.addEventListener('input', (e) => imgQualityVal.innerText = e.target.value);
    
    imgDrop.addEventListener('click', () => imgInput.click());
    imgInput.addEventListener('change', (e) => handleImgFiles(e.target.files));
    
    imgDrop.addEventListener('dragover', (e) => { e.preventDefault(); imgDrop.style.background = '#e9ecef'; });
    imgDrop.addEventListener('dragleave', (e) => { e.preventDefault(); imgDrop.style.background = '#f8f9fa'; });
    imgDrop.addEventListener('drop', (e) => {
        e.preventDefault();
        imgDrop.style.background = '#f8f9fa';
        handleImgFiles(e.dataTransfer.files);
    });

    function logImg(msg) {
        imgLog.innerHTML += `> ${msg}<br>`;
        imgLog.scrollTop = imgLog.scrollHeight;
    }

    function handleImgFiles(files) {
        imgFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
        if(imgFiles.length > 0) {
            logImg(`å·²é€‰æ‹© ${imgFiles.length} å¼ å›¾ç‰‡ã€‚`);
            imgStartBtn.disabled = false;
            imgStartBtn.innerText = `å¼€å§‹å‹ç¼© (${imgFiles.length} å¼ )`;
        }
    }

    imgStartBtn.addEventListener('click', async () => {
        const quality = parseInt(imgQuality.value) / 100;
        const maxWidth = parseInt(document.getElementById('img-max-width').value) || 0;
        const format = document.getElementById('img-format').value;
        const zip = new JSZip();

        imgStartBtn.disabled = true;
        document.getElementById('img-result-area').style.display = 'none';
        processedImages = [];
        logImg("=== å¼€å§‹å¤„ç† ===");

        for (let i = 0; i < imgFiles.length; i++) {
            const file = imgFiles[i];
            logImg(`æ­£åœ¨å¤„ç† (${i+1}/${imgFiles.length}): ${file.name}...`);
            
            try {
                const blob = await compressImage(file, quality, maxWidth, format);
                const saved = ((file.size - blob.size) / file.size * 100).toFixed(1);
                logImg(`âœ… æˆåŠŸ: ${(blob.size/1024).toFixed(1)}KB (èŠ‚çœ ${saved}%)`);
                
                // æ·»åŠ åˆ° ZIP
                let ext = format.split('/')[1];
                if(ext === 'jpeg') ext = 'jpg';
                const newName = file.name.substring(0, file.name.lastIndexOf('.')) + `_compressed.${ext}`;
                zip.file(newName, blob);

            } catch (err) {
                logImg(`âŒ å¤±è´¥: ${file.name} - ${err.message}`);
            }
        }

        logImg("=== å…¨éƒ¨å®Œæˆ ===");
        
        // å‡†å¤‡ä¸‹è½½
        document.getElementById('img-count').innerText = imgFiles.length;
        document.getElementById('img-result-area').style.display = 'block';
        imgStartBtn.disabled = false;
        imgStartBtn.innerText = "å†æ¬¡å‹ç¼©";

        // ç»‘å®šä¸‹è½½æŒ‰é’®
        document.getElementById('img-dl-btn').onclick = async () => {
            const content = await zip.generateAsync({type:"blob"});
            saveAs(content, "images_compressed.zip");
        };
    });

    // æ ¸å¿ƒå›¾ç‰‡å‹ç¼©å‡½æ•° (Canvas)
    function compressImage(file, quality, maxWidth, mimeType) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (maxWidth > 0 && width > maxWidth) {
                        height = Math.round(height * (maxWidth / width));
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    canvas.toBlob((blob) => {
                        if(blob) resolve(blob);
                        else reject(new Error("Canvas to Blob failed"));
                    }, mimeType, quality);
                };
                img.onerror = (err) => reject(err);
            };
            reader.onerror = (err) => reject(err);
        });
    }


    // ================== è§†é¢‘å¤„ç†é€»è¾‘ (FFmpeg WASM v0.11) ==================
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ 
        log: true, 
        corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js' 
    });

    const videoInput = document.getElementById('video-input');
    const videoDrop = document.getElementById('video-drop-area');
    const videoStartBtn = document.getElementById('video-start-btn');
    const videoLog = document.getElementById('video-log');
    const videoProgress = document.getElementById('video-progress-bar');
    
    let currentVideoFile = null;
    let videoMeta = { duration: 0 };

    function logVideo(msg) {
        videoLog.innerHTML += `> ${msg}<br>`;
        videoLog.scrollTop = videoLog.scrollHeight;
    }

    // åˆå§‹åŒ– FFmpeg
    (async () => {
        try {
            await ffmpeg.load();
            logVideo("âœ… ç³»ç»Ÿæ ¸å¿ƒå·²åŠ è½½ (FFmpeg v0.11)");
            logVideo("æç¤º: ä¸ºä¿è¯Webç«¯ä¸å´©æºƒï¼Œå»ºè®®ä¼˜å…ˆä½¿ç”¨ Ultrafast é¢„è®¾ã€‚");
        } catch(e) {
            logVideo("âŒ æ ¸å¿ƒåŠ è½½å¤±è´¥: " + e.message);
        }
    })();

    // è§†é¢‘æ–‡ä»¶é€‰æ‹©
    videoDrop.addEventListener('click', () => videoInput.click());
    videoInput.addEventListener('change', (e) => handleVideoFile(e.target.files[0]));

    function handleVideoFile(file) {
        if(!file) return;
        currentVideoFile = file;
        document.getElementById('video-file-label').innerText = `${file.name} (${(file.size/1024/1024).toFixed(1)} MB)`;
        videoStartBtn.disabled = false;
        
        // è·å–æ—¶é•¿
        const video = document.createElement('video');
        video.preload = 'metadata';
        video.src = URL.createObjectURL(file);
        video.onloadedmetadata = () => {
            videoMeta.duration = video.duration;
            logVideo(`å·²åŠ è½½: ${file.name}, æ—¶é•¿: ${videoMeta.duration.toFixed(1)}s`);
        };
    }

    // æ¨¡å¼åˆ‡æ¢
    const vidMode = document.getElementById('video-mode');
    vidMode.addEventListener('change', (e) => {
        if(e.target.value === 'crf') {
            document.getElementById('video-crf-ctrl').style.display = 'block';
            document.getElementById('video-target-ctrl').style.display = 'none';
        } else {
            document.getElementById('video-crf-ctrl').style.display = 'none';
            document.getElementById('video-target-ctrl').style.display = 'block';
        }
    });
    
    document.getElementById('video-crf-slider').addEventListener('input', (e) => {
        document.getElementById('video-crf-val').innerText = e.target.value;
    });

    // è§†é¢‘å‹ç¼©ä¸»å‡½æ•°
    videoStartBtn.addEventListener('click', async () => {
        if(!ffmpeg.isLoaded()) { alert("FFmpeg æ ¸å¿ƒæœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢"); return; }
        
        videoStartBtn.disabled = true;
        videoProgress.style.width = '0%';
        document.getElementById('video-result-area').style.display = 'none';
        
        const mode = vidMode.value;
        const preset = document.getElementById('video-preset').value;
        const res = document.getElementById('video-res').value;
        const audioBitrate = document.getElementById('video-audio').value;

        try {
            logVideo("æ­£åœ¨å°†è§†é¢‘å†™å…¥å†…å­˜...");
            ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(currentVideoFile));

            let args = ['-i', 'input.mp4'];

            // åˆ†è¾¨ç‡
            if(res === '720p') args.push('-vf', 'scale=-2:720');
            if(res === '1080p') args.push('-vf', 'scale=-2:1080');

            // ç¼–ç å™¨
            args.push('-c:v', 'libx264');
            args.push('-preset', preset); // è¿™é‡Œçš„ preset å¾ˆé‡è¦

            // æ¨¡å¼é€»è¾‘
            if(mode === 'target') {
                const targetMB = parseFloat(document.getElementById('video-target-mb').value);
                if(!targetMB) throw new Error("è¯·è¾“å…¥ç›®æ ‡å¤§å°");
                // ä½ çš„ Python ç®—æ³•: (TargetMB * 8192) / Duration - Audio
                const totalBits = targetMB * 1024 * 1024 * 8;
                let vRate = (totalBits / videoMeta.duration / 1000) - audioBitrate;
                if(vRate < 100) vRate = 100;
                logVideo(`ç›®æ ‡å¤§å°æ¨¡å¼: è®¡ç®—ç ç‡ ${Math.floor(vRate)}k`);
                args.push('-b:v', `${Math.floor(vRate)}k`);
            } else {
                const crf = document.getElementById('video-crf-slider').value;
                logVideo(`CRF æ¨¡å¼: ${crf}`);
                args.push('-crf', crf);
            }

            args.push('-c:a', 'aac', '-b:a', `${audioBitrate}k`);
            args.push('output.mp4');

            logVideo("ğŸ”¥ å¼€å§‹è½¬ç ... (Webç«¯å•çº¿ç¨‹è¿è¡Œä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…)");
            logVideo("æç¤º: è¿›åº¦æ¡å¯èƒ½è·³è·ƒï¼Œè¿™æ˜¯æ­£å¸¸çš„ã€‚");

            // è¿›åº¦ç›‘æ§
            ffmpeg.setProgress(({ ratio }) => {
                const pct = Math.floor(ratio * 100);
                if(pct > 0) {
                    videoProgress.style.width = `${pct}%`;
                    videoProgress.innerText = `${pct}%`;
                }
            });

            const startTime = Date.now();
            await ffmpeg.run(...args);
            const endTime = Date.now();

            logVideo(`âœ… è½¬ç å®Œæˆ! è€—æ—¶: ${((endTime - startTime)/1000).toFixed(1)}s`);
            videoProgress.style.width = '100%';

            // è¯»å–æ–‡ä»¶
            const data = ffmpeg.FS('readFile', 'output.mp4');
            const blob = new Blob([data.buffer], { type: 'video/mp4' });
            const url = URL.createObjectURL(blob);

            // æ˜¾ç¤ºä¸‹è½½
            document.getElementById('video-result-area').style.display = 'block';
            document.getElementById('vid-orig-size').innerText = (currentVideoFile.size/1024/1024).toFixed(1) + 'MB';
            document.getElementById('vid-new-size').innerText = (blob.size/1024/1024).toFixed(1) + 'MB';
            
            const dlBtn = document.getElementById('video-dl-link');
            dlBtn.href = url;
            dlBtn.download = `compressed_${currentVideoFile.name}`;

        } catch(err) {
            logVideo("âŒ é”™è¯¯: " + err.message);
            console.error(err);
        } finally {
            videoStartBtn.disabled = false;
        }
    });

</script>
</body>
</html>
