<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Tool (Smart v6.1)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        body { background-color: #f8f9fa; font-family: "Microsoft YaHei UI", sans-serif; }
        .main-container { max-width: 980px; margin: 30px auto; background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); overflow: hidden; }
        .header { background: #2c3e50; color: white; padding: 20px; } 
        .nav-tabs .nav-link { color: #495057; font-weight: 600; padding: 15px 25px; cursor: pointer; }
        .nav-tabs .nav-link.active { color: #2c3e50; border-bottom: 3px solid #2c3e50; }
        .tab-content { padding: 25px; }
        .drop-zone { border: 2px dashed #ced4da; background: #f8f9fa; padding: 30px; text-align: center; cursor: pointer; border-radius: 8px; transition: 0.3s; }
        .drop-zone:hover { border-color: #2c3e50; background: #e9ecef; }
        .log-box { background: #212529; color: #00ff00; font-family: Consolas, monospace; font-size: 0.85rem; height: 200px; overflow-y: auto; padding: 10px; border-radius: 6px; margin-top: 15px; white-space: pre-wrap; }
        .param-group { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #dee2e6; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
    </style>
</head>
<body>

<div class="main-container">
    <div class="header d-flex justify-content-between align-items-center">
        <h4 class="m-0">Media Tool <span class="badge bg-info text-dark" style="font-size:0.6em">Smart v6.1 (2025-12-23)</span></h4>
        <small>æ™ºèƒ½åˆ†è¾¨ç‡ & æ‰¹é‡å¤„ç†</small>
    </div>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation"><button class="nav-link active" id="img-tab" data-bs-toggle="tab" data-bs-target="#img-pane" type="button">ğŸ–¼ï¸ å›¾ç‰‡å‹ç¼©</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="video-tab" data-bs-toggle="tab" data-bs-target="#video-pane" type="button">ğŸ¬ è§†é¢‘å‹ç¼©</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="img-pane" role="tabpanel">
            <div class="row">
                <div class="col-md-5">
                    <div class="param-group">
                        <label class="form-label fw-bold">å›¾ç‰‡å‚æ•°</label>
                        <div class="mb-3">
                            <label>è´¨é‡ (5-100)</label>
                            <div class="d-flex">
                                <input type="range" class="form-range flex-grow-1" id="img-quality" min="5" max="100" value="50">
                                <span class="badge bg-secondary ms-2" id="img-val">50</span>
                            </div>
                        </div>
                        <div class="mb-3"><label>æœ€å¤§å®½åº¦ (px)</label><input type="number" class="form-control" id="img-width" value="0" placeholder="0=åŸå›¾"></div>
                        <div class="mb-3"><label>è¾“å‡ºæ ¼å¼</label><select class="form-select" id="img-fmt"><option value="image/jpeg">JPEG</option><option value="image/png">PNG</option><option value="image/webp">WEBP</option></select></div>
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="drop-zone" id="img-drop"><h5>ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</h5><input type="file" id="img-in" accept="image/*" multiple style="display:none"></div>
                    <button id="img-btn" class="btn btn-success w-100 mt-3" disabled>å¼€å§‹å‹ç¼©</button>
                    <div id="img-res" class="mt-3" style="display:none;"><div class="alert alert-success d-flex justify-content-between py-2"><span>å®Œæˆ: <b id="img-count">0</b> å¼ </span><button id="img-dl" class="btn btn-sm btn-outline-success" style="background:white;">ğŸ“¦ æ‰“åŒ…ä¸‹è½½ (ZIP)</button></div></div>
                </div>
            </div>
            <div class="log-box" id="img-log">ç­‰å¾…é€‰æ‹©å›¾ç‰‡...</div>
        </div>

        <div class="tab-pane fade" id="video-pane" role="tabpanel">
            <div class="alert alert-info py-2 small"><i class="bi bi-magic"></i> <strong>æ™ºèƒ½æ¨¡å¼ï¼š</strong> å¦‚æœåŸè§†é¢‘åˆ†è¾¨ç‡ä½äºç›®æ ‡è®¾ç½®ï¼Œå°†è‡ªåŠ¨ä¿æŒåŸç”»è´¨ï¼Œé¿å…å¼ºåˆ¶æ”¾å¤§ã€‚</div>
            
            <div class="drop-zone py-4" id="vid-drop">
                <h5 class="mb-1">ğŸ“‚ ç‚¹å‡»é€‰æ‹©è§†é¢‘ (æ”¯æŒå¤šé€‰)</h5>
                <p class="text-muted small mb-0" id="vid-lbl">æœªé€‰æ‹©æ–‡ä»¶</p>
                <input type="file" id="vid-in" accept="video/*" multiple style="display:none">
            </div>

            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="param-group">
                        <label class="fw-bold">æ¨¡å¼</label>
                        <select class="form-select mb-2" id="vid-mode"><option value="crf">CRF ç”»è´¨ä¼˜å…ˆ</option><option value="target">ç›®æ ‡å¤§å°ä¼˜å…ˆ</option></select>
                        <div id="crf-box">
                            <label class="small text-muted">CRF (18-35): <span id="crf-val" class="text-primary fw-bold">25</span></label>
                            <input type="range" class="form-range" id="vid-crf" min="18" max="35" value="25">
                        </div>
                        <div id="tgt-box" style="display:none;"><label class="small text-muted">ç›®æ ‡å¤§å° (MB)</label><input type="number" class="form-control" id="vid-tgt" placeholder="50"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="param-group">
                        <label class="fw-bold">è®¾ç½®</label>
                        <div class="row g-2">
                            <div class="col-6"><label class="small text-muted">åˆ†è¾¨ç‡</label><select class="form-select form-select-sm" id="vid-res"><option value="1080p" selected>1080p</option><option value="720p">720p</option><option value="orig">åŸå§‹</option></select></div>
                            <div class="col-6"><label class="small text-muted">é€Ÿåº¦é¢„è®¾</label><select class="form-select form-select-sm" id="vid-pre">
                                <option value="ultrafast" selected>Ultrafast (é»˜è®¤)</option>
                                <option value="superfast">Superfast</option>
                                <option value="veryfast">Veryfast</option>
                                <option value="faster">Faster</option>
                            </select></div>
                            <div class="col-6 mt-2"><label class="small text-muted">éŸ³é¢‘(kbps)</label><input type="number" class="form-control form-control-sm" id="vid-aud" value="96"></div>
                            <div class="col-6 mt-2"><label class="small text-muted">ç¼–ç æ ¼å¼</label><select class="form-select form-select-sm" id="vid-codec"><option value="libx264" selected>H.264</option><option value="libx265">H.265</option></select></div>
                        </div>
                    </div>
                </div>
            </div>

            <button id="vid-btn" class="btn btn-primary w-100 py-2" disabled>å¼€å§‹æ‰¹é‡å‹ç¼©</button>
            <div class="progress mt-3" style="height: 25px;">
                <div id="vid-prog" class="progress-bar progress-bar-striped progress-bar-animated bg-info" style="width: 0%; transition: width 0.3s;">0%</div>
            </div>
            <div class="log-box mt-3" id="vid-log">ç³»ç»Ÿæ­£åœ¨åˆå§‹åŒ–æ ¸å¿ƒ...</div>
            
            <div id="vid-res-area" class="mt-3 text-center" style="display:none;">
                <div class="alert alert-success d-flex justify-content-between align-items-center py-2">
                    <span>âœ… å…¨éƒ¨å®Œæˆ (<b id="vid-done-count">0</b>ä¸ª)</span>
                    <button id="vid-dl-zip" class="btn btn-success">ğŸ“¦ æ‰“åŒ…ä¸‹è½½æ‰€æœ‰è§†é¢‘ (ZIP)</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- å›¾ç‰‡é€»è¾‘ ---
    const I_img = (id) => document.getElementById(id);
    let imgFiles = [];
    function logImg(msg) { I_img('img-log').innerHTML += `> ${msg}<br>`; I_img('img-log').scrollTop = I_img('img-log').scrollHeight; }
    
    I_img('img-quality').oninput = (e) => I_img('img-val').innerText = e.target.value;
    I_img('img-drop').onclick = () => I_img('img-in').click();
    I_img('img-in').onchange = (e) => {
        imgFiles = Array.from(e.target.files);
        if(imgFiles.length>0) { I_img('img-log').innerHTML=''; logImg(`é€‰å®š ${imgFiles.length} å¼ `); I_img('img-btn').disabled=false; I_img('img-btn').innerText=`å¼€å§‹ (${imgFiles.length})`; }
    };
    I_img('img-btn').onclick = async () => {
        const zip = new JSZip();
        I_img('img-btn').disabled=true; I_img('img-res').style.display='none';
        for(let i=0; i<imgFiles.length; i++) {
            const f = imgFiles[i];
            logImg(`å¤„ç†: ${f.name}...`);
            try {
                const blob = await compressImg(f, I_img('img-quality').value/100, I_img('img-width').value, I_img('img-fmt').value);
                const saved = ((f.size-blob.size)/f.size*100).toFixed(1);
                logImg(`<span style="color:#00ff00">âœ… æˆåŠŸ (çœ${saved}%)</span>`);
                let ext = I_img('img-fmt').value.split('/')[1].replace('jpeg','jpg');
                zip.file(f.name.replace(/\.[^/.]+$/, "")+`_opt.${ext}`, blob);
            } catch(e) { logImg(`<span style="color:red">âŒ å¤±è´¥</span>`); }
        }
        I_img('img-count').innerText=imgFiles.length; I_img('img-res').style.display='block';
        I_img('img-dl').onclick = async () => saveAs(await zip.generateAsync({type:"blob"}), "images_opt.zip");
        I_img('img-btn').disabled=false; I_img('img-btn').innerText="å†æ¬¡å‹ç¼©";
    };
    function compressImg(file, q, w, fmt) {
        return new Promise((res, rej) => {
            const r = new FileReader(); r.readAsDataURL(file);
            r.onload = e => {
                const img = new Image(); img.src = e.target.result;
                img.onload = () => {
                    const c = document.createElement('canvas');
                    let rw=img.width, rh=img.height;
                    if(w>0 && rw>w) { rh=Math.round(rh*(w/rw)); rw=w; }
                    c.width=rw; c.height=rh;
                    c.getContext('2d').drawImage(img,0,0,rw,rh);
                    c.toBlob(b=>res(b), fmt, q);
                };
            };
        });
    }

    // --- è§†é¢‘é€»è¾‘ (v6.1 Smart Batch) ---
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ 
        log: true, 
        corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js' 
    });

    const I = (id) => document.getElementById(id);
    let vidFiles = [];
    
    function logVid(msg) { I('vid-log').innerHTML += `> ${msg}<br>`; I('vid-log').scrollTop = I('vid-log').scrollHeight; }

    (async () => {
        try {
            await ffmpeg.load();
            I('vid-log').innerHTML = "âœ… å¼•æ“åŠ è½½æˆåŠŸ (Smart v6.1)<br>> è¿›åº¦æ¡å·²ä¿®å¤ï¼Œæ”¯æŒæ™ºèƒ½åˆ†è¾¨ç‡åˆ¤æ–­ã€‚";
        } catch(e) {
            I('vid-log').innerHTML = `<span style="color:red">âŒ åŠ è½½å¤±è´¥: ${e.message}</span>`;
        }
    })();

    I('vid-drop').onclick = () => I('vid-in').click();
    I('vid-in').onchange = (e) => {
        vidFiles = Array.from(e.target.files);
        if(vidFiles.length === 0) return;
        I('vid-lbl').innerText = `å·²é€‰æ‹© ${vidFiles.length} ä¸ªè§†é¢‘æ–‡ä»¶`;
        I('vid-log').innerHTML = ""; 
        logVid(`å·²åŠ è½½ ${vidFiles.length} ä¸ªæ–‡ä»¶ï¼Œå‡†å¤‡å°±ç»ªã€‚`);
        I('vid-btn').disabled = false;
        I('vid-btn').innerText = `å¼€å§‹å‹ç¼© (${vidFiles.length}ä¸ª)`;
    };

    I('vid-mode').onchange = (e) => { I('crf-box').style.display = e.target.value==='crf'?'block':'none'; I('tgt-box').style.display = e.target.value==='target'?'block':'none'; };
    I('vid-crf').oninput = (e) => I('crf-val').innerText = e.target.value;

    // è·å–è§†é¢‘å…ƒæ•°æ® (åŒ…å«åˆ†è¾¨ç‡)
    const getVideoMeta = (file) => {
        return new Promise((resolve) => {
            const v = document.createElement('video');
            v.preload = 'metadata';
            v.src = URL.createObjectURL(file);
            v.onloadedmetadata = () => {
                resolve({ 
                    duration: v.duration,
                    width: v.videoWidth,
                    height: v.videoHeight
                });
                URL.revokeObjectURL(v.src); 
            };
            v.onerror = () => resolve({ duration: 0, width: 0, height: 0 });
        });
    };

    I('vid-btn').onclick = async () => {
        if(!ffmpeg.isLoaded() || vidFiles.length === 0) return;
        
        const zip = new JSZip();
        I('vid-btn').disabled = true;
        I('vid-res-area').style.display = 'none';
        
        logVid("=== å¼€å§‹æ‰¹é‡å¤„ç†é˜Ÿåˆ— ===");

        for (let i = 0; i < vidFiles.length; i++) {
            const file = vidFiles[i];
            const idx = i + 1;
            
            logVid(`----------\n[${idx}/${vidFiles.length}] æ­£åœ¨å¤„ç†: ${file.name}`);
            I('vid-prog').style.width = '1%'; // ç¨å¾®ç»™ç‚¹å®½åº¦è¡¨ç¤ºå¼€å§‹
            I('vid-prog').innerText = '0%';
            
            try {
                const meta = await getVideoMeta(file);
                
                ffmpeg.FS('writeFile', 'in.mp4', await fetchFile(file));
                
                const codec = I('vid-codec').value;
                let args = ['-i', 'in.mp4', '-c:v', codec];
                args.push('-preset', I('vid-pre').value);
                
                // --- æ™ºèƒ½åˆ†è¾¨ç‡é€»è¾‘ ---
                let targetHeight = 0;
                if(I('vid-res').value === '720p') targetHeight = 720;
                if(I('vid-res').value === '1080p') targetHeight = 1080;

                if (targetHeight > 0) {
                    // å¦‚æœåŸè§†é¢‘é«˜åº¦ < ç›®æ ‡é«˜åº¦ï¼Œä¿æŒåŸæ ·
                    if (meta.height < targetHeight) {
                        logVid(`â„¹ æ™ºèƒ½åˆ¤æ–­: åŸåˆ†è¾¨ç‡(${meta.height}p) < ç›®æ ‡(${targetHeight}p)ï¼Œå·²ä¿æŒåŸå§‹åˆ†è¾¨ç‡ã€‚`);
                        // ä¸æ·»åŠ  -vf scale å‚æ•°
                    } else {
                        args.push('-vf', `scale=-2:${targetHeight}`);
                    }
                }
                // ---------------------

                if(I('vid-mode').value === 'target') {
                    const tgt = parseFloat(I('vid-tgt').value);
                    const dur = meta.duration || 10; 
                    const br = Math.floor((tgt * 8388608 / dur) - (I('vid-aud').value*1000));
                    args.push('-b:v', `${Math.max(br, 50000)}`);
                } else {
                    args.push('-crf', I('vid-crf').value);
                }
                
                args.push('-c:a', 'aac', '-b:a', `${I('vid-aud').value}k`, 'out.mp4');

                // ä¿®å¤ï¼šè¿›åº¦å›è°ƒ
                ffmpeg.setProgress(({ ratio }) => {
                    // ç¡®ä¿æ¯”ç‡æœ‰æ•ˆä¸”è½¬æ¢ä¸ºç™¾åˆ†æ¯”
                    const p = Math.round(ratio * 100);
                    if(p >= 0 && p <= 100) {
                        I('vid-prog').style.width = `${p}%`;
                        I('vid-prog').innerText = `${p}%`;
                    }
                });

                await ffmpeg.run(...args);

                const data = ffmpeg.FS('readFile', 'out.mp4');
                const newName = `compressed_${file.name.replace(/\.[^/.]+$/, "")}.mp4`;
                zip.file(newName, data);
                
                const saved = ((file.size - data.byteLength)/file.size*100).toFixed(1);
                logVid(`<span style="color:#00ff00">âœ… æˆåŠŸ: ${newName} (çœ${saved}%)</span>`);
                
                ffmpeg.FS('unlink', 'in.mp4');
                ffmpeg.FS('unlink', 'out.mp4');

            } catch (err) {
                logVid(`<span style="color:red">âŒ å¤±è´¥: ${file.name} - ${err.message}</span>`);
                try { ffmpeg.FS('unlink', 'in.mp4'); } catch(e){}
            }
        }

        logVid("=== é˜Ÿåˆ—å¤„ç†ç»“æŸ ===");
        
        I('vid-done-count').innerText = vidFiles.length;
        I('vid-res-area').style.display = 'block';
        
        I('vid-dl-zip').onclick = async () => {
            I('vid-dl-zip').innerText = "æ‰“åŒ…ä¸­...";
            const content = await zip.generateAsync({type:"blob"});
            saveAs(content, "videos_compressed.zip");
            I('vid-dl-zip').innerText = "ğŸ“¦ æ‰“åŒ…ä¸‹è½½æ‰€æœ‰è§†é¢‘ (ZIP)";
        };
        
        I('vid-btn').disabled = false;
        I('vid-btn').innerText = "å†æ¬¡å‹ç¼©";
    };
</script>
</body>
</html>
