<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halo Media Compressor Web v4.6</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: "Microsoft YaHei UI", sans-serif; }
        .container { max-width: 900px; margin-top: 30px; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .log-box { background: #2d2d2d; color: #00ff00; font-family: monospace; height: 150px; overflow-y: auto; padding: 10px; border-radius: 5px; font-size: 0.85rem; }
        .drop-zone { border: 2px dashed #0d6efd; background: #f0f8ff; padding: 30px; text-align: center; cursor: pointer; border-radius: 10px; transition: all 0.2s; }
        .drop-zone:hover { background: #e0f0ff; }
        .param-group { background: #f1f3f5; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        h4 { color: #0d6efd; margin-bottom: 20px; }
        /* éšè—åŸç”Ÿæ–‡ä»¶è¾“å…¥ */
        #file-input { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center">
        <h4>Halo Media Compressor <span class="badge bg-secondary" style="font-size:0.6em">Web Port v4.6</span></h4>
    </div>

    <div class="drop-zone" id="drop-area">
        <h5 class="mb-2">ğŸ“‚ ç‚¹å‡»æˆ–æ‹–æ‹½è§†é¢‘æ–‡ä»¶åˆ°æ­¤å¤„</h5>
        <p class="text-muted small mb-0">æ”¯æŒ MP4, MOV, MKV, AVI</p>
        <input type="file" id="file-input" accept="video/*">
    </div>

    <div id="file-info-card" class="card mt-3" style="display:none;">
        <div class="card-body py-2">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <strong>å½“å‰æ–‡ä»¶:</strong> <span id="file-name">-</span>
                </div>
                <div class="col-md-3">
                    <small class="text-muted">æ—¶é•¿: <span id="file-duration">-</span></small>
                </div>
                <div class="col-md-3">
                    <small class="text-muted">åŸå§‹: <span id="file-size">-</span></small>
                </div>
            </div>
        </div>
    </div>

    <hr>

    <div class="row">
        <div class="col-md-6">
            <div class="param-group">
                <label class="form-label fw-bold">å‹ç¼©æ¨¡å¼</label>
                <select class="form-select mb-3" id="mode-select">
                    <option value="crf">CRF ç”»è´¨ä¼˜å…ˆ (é»˜è®¤)</option>
                    <option value="target">ç›®æ ‡å¤§å°ä¼˜å…ˆ</option>
                </select>

                <div id="crf-controls">
                    <label class="form-label">CRF å€¼ (18-35): <span id="crf-val" class="text-primary fw-bold">23</span></label>
                    <input type="range" class="form-range" id="crf-slider" min="18" max="35" value="23">
                    <div class="form-text small">å€¼è¶Šå°ç”»è´¨è¶Šå¥½ä½“ç§¯è¶Šå¤§ï¼Œæ¨è 23-28ã€‚</div>
                </div>

                <div id="target-controls" style="display:none;">
                    <label class="form-label">ç›®æ ‡å¤§å° (MB)</label>
                    <input type="number" class="form-control" id="target-mb" placeholder="ä¾‹å¦‚: 50">
                    <div class="form-text small">ç¨‹åºå°†è‡ªåŠ¨è®¡ç®—è§†é¢‘ç ç‡ä»¥æ¥è¿‘æ­¤å¤§å°ã€‚</div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="param-group">
                <div class="row g-2">
                    <div class="col-6">
                        <label class="form-label small">åˆ†è¾¨ç‡é™åˆ¶</label>
                        <select class="form-select form-select-sm" id="res-select">
                            <option value="orig">åŸå§‹åˆ†è¾¨ç‡</option>
                            <option value="720p">é™åˆ¶ 720p</option>
                            <option value="1080p">é™åˆ¶ 1080p</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label class="form-label small">ç¼–ç é€Ÿåº¦ (Preset)</label>
                        <select class="form-select form-select-sm" id="preset-select">
                            <option value="ultrafast">Ultrafast (æœ€å¿«)</option>
                            <option value="veryfast" selected>Veryfast (æ¨è)</option>
                            <option value="medium">Medium (è¾ƒæ…¢)</option>
                        </select>
                    </div>
                    <div class="col-6 mt-3">
                        <label class="form-label small">éŸ³é¢‘ç ç‡ (kbps)</label>
                        <input type="number" class="form-control form-control-sm" id="audio-bitrate" value="128">
                    </div>
                    <div class="col-6 mt-3">
                        <label class="form-label small">ç¼–ç å™¨</label>
                        <select class="form-select form-select-sm" disabled>
                            <option>H.264 (é€šç”¨)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-2">
        <button id="start-btn" class="btn btn-success w-100 py-2" disabled>å¼€å§‹å‹ç¼©</button>
        <div class="progress mt-3" style="height: 25px;">
            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar" style="width: 0%">0%</div>
        </div>
    </div>

    <div class="mt-3">
        <label class="form-label fw-bold">è¿è¡Œæ—¥å¿—</label>
        <div class="log-box" id="log-area">ç­‰å¾…ç³»ç»Ÿåˆå§‹åŒ–...</div>
    </div>
    
    <div id="result-area" class="mt-3 text-center" style="display:none;">
        <h5 class="text-success">âœ… å‹ç¼©å®Œæˆ</h5>
        <p>å‹ç¼©åå¤§å°: <b id="final-size"></b> (å‹ç¼©ç‡: <span id="save-rate"></span>)</p>
        <a id="dl-link" class="btn btn-primary">â¬‡ï¸ ä¸‹è½½å‹ç¼©åçš„è§†é¢‘</a>
        <video id="preview-video" controls class="w-100 mt-2" style="max-height:300px; background:black;"></video>
    </div>

</div>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    // ä½¿ç”¨ v0.11 æ ¸å¿ƒï¼Œæ— éœ€ SharedArrayBufferï¼Œå…¼å®¹æ€§ 100%
    const ffmpeg = createFFmpeg({ 
        log: true, 
        corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js' 
    });

    // UI å…ƒç´ ç»‘å®š
    const dropArea = document.getElementById('drop-area');
    const fileInput = document.getElementById('file-input');
    const logArea = document.getElementById('log-area');
    const startBtn = document.getElementById('start-btn');
    const progressBar = document.getElementById('progress-bar');
    
    // å‚æ•°å…ƒç´ 
    const modeSelect = document.getElementById('mode-select');
    const crfControls = document.getElementById('crf-controls');
    const targetControls = document.getElementById('target-controls');
    const crfSlider = document.getElementById('crf-slider');
    const crfVal = document.getElementById('crf-val');

    let currentFile = null;
    let fileMeta = { duration: 0, width: 0, height: 0 };

    // --- åˆå§‹åŒ– ---
    const log = (msg) => {
        logArea.innerHTML += `> ${msg}<br>`;
        logArea.scrollTop = logArea.scrollHeight;
    }

    (async () => {
        try {
            await ffmpeg.load();
            log("ç³»ç»Ÿå°±ç»ª (Core v0.11)");
            log("æ³¨æ„ï¼šWebç«¯è¿è¡Œé€Ÿåº¦å–å†³äºæ‚¨çš„CPUæ€§èƒ½");
        } catch(e) {
            log("âŒ FFmpeg åŠ è½½å¤±è´¥: " + e.message);
        }
    })();

    // --- UI äº¤äº’é€»è¾‘ (å¤åˆ» Python é€»è¾‘) ---
    modeSelect.addEventListener('change', (e) => {
        if(e.target.value === 'crf') {
            crfControls.style.display = 'block';
            targetControls.style.display = 'none';
        } else {
            crfControls.style.display = 'none';
            targetControls.style.display = 'block';
        }
    });

    crfSlider.addEventListener('input', (e) => {
        crfVal.innerText = e.target.value;
    });

    // --- æ–‡ä»¶å¤„ç† ---
    const handleFile = async (file) => {
        if(!file) return;
        currentFile = file;
        
        // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        document.getElementById('file-info-card').style.display = 'block';
        document.getElementById('file-name').innerText = file.name;
        document.getElementById('file-size').innerText = (file.size / 1024 / 1024).toFixed(2) + ' MB';
        
        // è·å–è§†é¢‘å…ƒæ•°æ® (æ—¶é•¿/åˆ†è¾¨ç‡)
        const url = URL.createObjectURL(file);
        const videoTest = document.createElement('video');
        videoTest.preload = 'metadata';
        videoTest.src = url;
        videoTest.onloadedmetadata = () => {
            fileMeta.duration = videoTest.duration;
            fileMeta.width = videoTest.videoWidth;
            fileMeta.height = videoTest.videoHeight;
            
            const h = Math.floor(videoTest.duration / 3600);
            const m = Math.floor((videoTest.duration % 3600) / 60);
            const s = Math.floor(videoTest.duration % 60);
            document.getElementById('file-duration').innerText = `${h}:${m}:${s}`;
            
            startBtn.disabled = false;
            startBtn.innerText = "å¼€å§‹å‹ç¼©";
            log(`å·²åŠ è½½: ${file.name} (æ—¶é•¿: ${fileMeta.duration.toFixed(1)}s, åˆ†è¾¨ç‡: ${fileMeta.width}x${fileMeta.height})`);
        };
    };

    dropArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
    
    dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.style.background = '#e0f0ff'; });
    dropArea.addEventListener('dragleave', (e) => { e.preventDefault(); dropArea.style.background = '#f0f8ff'; });
    dropArea.addEventListener('drop', (e) => {
        e.preventDefault();
        dropArea.style.background = '#f0f8ff';
        const files = e.dataTransfer.files;
        if(files.length > 0) handleFile(files[0]);
    });

    // --- æ ¸å¿ƒå‹ç¼©é€»è¾‘ (ç¿»è¯‘è‡ª Python) ---
    startBtn.addEventListener('click', async () => {
        if(!ffmpeg.isLoaded() || !currentFile) return;

        startBtn.disabled = true;
        document.getElementById('result-area').style.display = 'none';
        log("æ­£åœ¨å†™å…¥å†…å­˜...");
        
        // 1. å†™å…¥æ–‡ä»¶
        ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(currentFile));

        // 2. æ„å»ºå‘½ä»¤ (Command Builder)
        let args = ['-i', 'input.mp4'];
        
        const mode = modeSelect.value;
        const preset = document.getElementById('preset-select').value;
        const resMode = document.getElementById('res-select').value;
        const audioBitrate = document.getElementById('audio-bitrate').value || 128;

        // åˆ†è¾¨ç‡ç¼©æ”¾é€»è¾‘
        if(resMode === '720p' && fileMeta.height > 720) {
            args.push('-vf', 'scale=-2:720');
            log("åº”ç”¨æ»¤é•œ: ç¼©æ”¾åˆ° 720p");
        } else if(resMode === '1080p' && fileMeta.height > 1080) {
            args.push('-vf', 'scale=-2:1080');
            log("åº”ç”¨æ»¤é•œ: ç¼©æ”¾åˆ° 1080p");
        }

        // ç ç‡æ§åˆ¶é€»è¾‘
        args.push('-c:v', 'libx264');
        
        if (mode === 'target') {
            // ç›®æ ‡å¤§å°æ¨¡å¼ (Target Size Mode)
            const targetMB = parseFloat(document.getElementById('target-mb').value);
            if (!targetMB || targetMB <= 0) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ç›®æ ‡å¤§å°");
                startBtn.disabled = false;
                return;
            }
            
            // ç®—æ³•: Bitrate = (TargetMB * 8192) / Duration - AudioBitrate
            const totalBits = targetMB * 1024 * 1024 * 8;
            let videoBitrateKbps = (totalBits / fileMeta.duration / 1000) - audioBitrate;
            if (videoBitrateKbps < 300) videoBitrateKbps = 300; // æœ€ä½ä¿æŠ¤

            log(`ç›®æ ‡å¤§å°æ¨¡å¼: è®¾å®š ${targetMB} MB`);
            log(`è®¡ç®—è§†é¢‘ç ç‡: ${Math.floor(videoBitrateKbps)}k (éŸ³é¢‘: ${audioBitrate}k)`);
            
            args.push('-b:v', `${Math.floor(videoBitrateKbps)}k`);
        } else {
            // CRF æ¨¡å¼
            const crf = document.getElementById('crf-slider').value;
            log(`CRF æ¨¡å¼: è´¨é‡ç³»æ•° ${crf}`);
            args.push('-crf', crf);
        }

        args.push('-preset', preset);
        args.push('-c:a', 'aac', '-b:a', `${audioBitrate}k`);
        args.push('output.mp4');

        // 3. æ‰§è¡Œ FFmpeg
        log("å¼€å§‹è½¬ç ... (è¯·å‹¿å…³é—­é¡µé¢)");
        progressBar.style.width = '0%';
        progressBar.classList.add('progress-bar-animated');
        
        // ç®€æ˜“è¿›åº¦æ¨¡æ‹Ÿ (v0.11 çš„ progress æœ‰æ—¶ä¸å¦‚ v0.12 å‡†ç¡®)
        ffmpeg.setProgress(({ ratio }) => {
            const pct = Math.floor(ratio * 100);
            if(pct > 0 && pct <= 100) {
                progressBar.style.width = `${pct}%`;
                progressBar.innerText = `${pct}%`;
            }
        });

        const startTime = Date.now();
        await ffmpeg.run(...args);
        
        const duration = (Date.now() - startTime) / 1000;
        log(`âœ… è½¬ç å®Œæˆ! è€—æ—¶: ${duration.toFixed(1)}ç§’`);
        progressBar.style.width = '100%';
        progressBar.innerText = '100%';
        progressBar.classList.remove('progress-bar-animated');

        // 4. è·å–ç»“æœ
        const data = ffmpeg.FS('readFile', 'output.mp4');
        const blob = new Blob([data.buffer], { type: 'video/mp4' });
        const outUrl = URL.createObjectURL(blob);

        // æ˜¾ç¤ºç»“æœ
        const resultArea = document.getElementById('result-area');
        resultArea.style.display = 'block';
        
        document.getElementById('preview-video').src = outUrl;
        
        const dlLink = document.getElementById('dl-link');
        dlLink.href = outUrl;
        dlLink.download = `compressed_${currentFile.name}`; // ä¿æŒåŸæ–‡ä»¶ååŠ å‰ç¼€

        // è®¡ç®—å‹ç¼©æ•°æ®
        const finalSizeMB = blob.size / 1024 / 1024;
        const origSizeMB = currentFile.size / 1024 / 1024;
        const saved = ((origSizeMB - finalSizeMB) / origSizeMB * 100).toFixed(1);
        
        document.getElementById('final-size').innerText = finalSizeMB.toFixed(2) + " MB";
        document.getElementById('save-rate').innerHTML = `<span class="${saved > 0 ? 'text-success' : 'text-danger'}">èŠ‚çœ ${saved}%</span>`;
        
        startBtn.disabled = false;
        startBtn.innerText = "é‡æ–°å‹ç¼©";
    });
</script>

</body>
</html>
