<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halo Media Tool (Customized v5.3)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        body { background-color: #f8f9fa; font-family: "Microsoft YaHei UI", sans-serif; }
        .main-container { max-width: 980px; margin: 30px auto; background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); overflow: hidden; }
        .header { background: #2c3e50; color: white; padding: 20px; } 
        .nav-tabs .nav-link { color: #495057; font-weight: 600; padding: 15px 25px; cursor: pointer; }
        .nav-tabs .nav-link.active { color: #2c3e50; border-bottom: 3px solid #2c3e50; }
        .tab-content { padding: 25px; }
        .drop-zone { border: 2px dashed #ced4da; background: #f8f9fa; padding: 30px; text-align: center; cursor: pointer; border-radius: 8px; transition: 0.3s; }
        .drop-zone:hover { border-color: #2c3e50; background: #e9ecef; }
        .log-box { background: #212529; color: #00ff00; font-family: Consolas, monospace; font-size: 0.85rem; height: 180px; overflow-y: auto; padding: 10px; border-radius: 6px; margin-top: 15px; white-space: pre-wrap; }
        .param-group { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #dee2e6; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
    </style>
</head>
<body>

<div class="main-container">
    <div class="header d-flex justify-content-between align-items-center">
        <h4 class="m-0">Halo Media Tool <span class="badge bg-warning text-dark" style="font-size:0.6em">v5.3 Custom</span></h4>
        <small>Universal Compatibility</small>
    </div>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation"><button class="nav-link active" id="img-tab" data-bs-toggle="tab" data-bs-target="#img-pane" type="button">ğŸ–¼ï¸ å›¾ç‰‡å‹ç¼©</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="video-tab" data-bs-toggle="tab" data-bs-target="#video-pane" type="button">ğŸ¬ è§†é¢‘å‹ç¼©</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="img-pane" role="tabpanel">
            <div class="row">
                <div class="col-md-5">
                    <div class="param-group">
                        <label class="form-label fw-bold">å›¾ç‰‡å‚æ•°</label>
                        <div class="mb-3"><label>è´¨é‡ (5-100)</label><div class="d-flex"><input type="range" class="form-range flex-grow-1" id="img-quality" min="5" max="100" value="75"><span class="badge bg-secondary ms-2" id="img-val">75</span></div></div>
                        <div class="mb-3"><label>æœ€å¤§å®½åº¦ (px)</label><input type="number" class="form-control" id="img-width" value="0" placeholder="0=åŸå›¾"></div>
                        <div class="mb-3"><label>è¾“å‡ºæ ¼å¼</label><select class="form-select" id="img-fmt"><option value="image/jpeg">JPEG</option><option value="image/png">PNG</option><option value="image/webp">WEBP</option></select></div>
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="drop-zone" id="img-drop"><h5>ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</h5><input type="file" id="img-in" accept="image/*" multiple style="display:none"></div>
                    <button id="img-btn" class="btn btn-success w-100 mt-3" disabled>å¼€å§‹å‹ç¼©</button>
                    <div id="img-res" class="mt-3" style="display:none;"><div class="alert alert-success d-flex justify-content-between py-2"><span>å®Œæˆ: <b id="img-count">0</b> å¼ </span><button id="img-dl" class="btn btn-sm btn-outline-success" style="background:white;">ğŸ“¦ ä¸‹è½½ZIP</button></div></div>
                </div>
            </div>
            <div class="log-box" id="img-log">ç­‰å¾…é€‰æ‹©å›¾ç‰‡...</div>
        </div>

        <div class="tab-pane fade" id="video-pane" role="tabpanel">
            <div class="alert alert-secondary py-2 small"><i class="bi bi-info-circle"></i> <strong>æç¤ºï¼š</strong> Veryfast æ¨¡å¼åœ¨ç½‘é¡µç«¯å¯èƒ½è¾ƒæ…¢ï¼Œè‹¥æ„Ÿè§‰å¡é¡¿å»ºè®®æ”¹å› Ultrafastã€‚</div>
            
            <div class="drop-zone py-4" id="vid-drop">
                <h5 class="mb-1">ğŸ“‚ ç‚¹å‡»é€‰æ‹©è§†é¢‘</h5>
                <p class="text-muted small mb-0" id="vid-lbl">æœªé€‰æ‹©æ–‡ä»¶</p>
                <input type="file" id="vid-in" accept="video/*" style="display:none">
            </div>

            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="param-group">
                        <label class="fw-bold">æ¨¡å¼</label>
                        <select class="form-select mb-2" id="vid-mode"><option value="crf">CRF ç”»è´¨ä¼˜å…ˆ</option><option value="target">ç›®æ ‡å¤§å°ä¼˜å…ˆ</option></select>
                        <div id="crf-box">
                            <label class="small text-muted">CRF (18-35): <span id="crf-val" class="text-primary fw-bold">25</span></label>
                            <input type="range" class="form-range" id="vid-crf" min="18" max="35" value="25">
                        </div>
                        <div id="tgt-box" style="display:none;"><label class="small text-muted">ç›®æ ‡å¤§å° (MB)</label><input type="number" class="form-control" id="vid-tgt" placeholder="50"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="param-group">
                        <label class="fw-bold">è¯¦ç»†è®¾ç½®</label>
                        <div class="row g-2">
                            <div class="col-6"><label class="small text-muted">åˆ†è¾¨ç‡</label><select class="form-select form-select-sm" id="vid-res"><option value="1080p" selected>1080p</option><option value="720p">720p</option><option value="orig">åŸå§‹</option></select></div>
                            
                            <div class="col-6"><label class="small text-muted">é€Ÿåº¦é¢„è®¾</label><select class="form-select form-select-sm" id="vid-pre">
                                <option value="veryfast" selected>Veryfast (é»˜è®¤)</option>
                                <option value="faster">Faster</option>
                                <option value="ultrafast">Ultrafast (æé€Ÿ)</option>
                                <option value="superfast">Superfast</option>
                            </select></div>
                            
                            <div class="col-6 mt-2"><label class="small text-muted">éŸ³é¢‘(kbps)</label><input type="number" class="form-control form-control-sm" id="vid-aud" value="96"></div>
                            
                            <div class="col-6 mt-2"><label class="small text-muted">ç¼–ç æ ¼å¼</label><select class="form-select form-select-sm" id="vid-codec"><option value="libx264" selected>H.264 (é»˜è®¤)</option><option value="libx265">H.265 (HEVC)</option></select></div>
                        </div>
                    </div>
                </div>
            </div>

            <button id="vid-btn" class="btn btn-primary w-100 py-2" disabled>å¼€å§‹è§†é¢‘å‹ç¼©</button>
            <div class="progress mt-3" style="height: 25px;"><div id="vid-prog" class="progress-bar progress-bar-striped progress-bar-animated bg-info" style="width: 0%">0%</div></div>
            <div class="log-box mt-3" id="vid-log">ç³»ç»Ÿæ­£åœ¨åˆå§‹åŒ–æ ¸å¿ƒ (v0.11 Custom)...</div>
            <div id="vid-res-area" class="mt-3 text-center" style="display:none;"><p>å‹ç¼©å‰: <b id="orig-size"></b> -> å: <b id="new-size"></b> (<span id="saved-pct"></span>)</p><a id="vid-dl" class="btn btn-primary">â¬‡ï¸ ä¸‹è½½è§†é¢‘</a></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- å›¾ç‰‡é€»è¾‘ (ä¿æŒä¸å˜) ---
    const I_img = (id) => document.getElementById(id);
    let imgFiles = [];
    function logImg(msg) { I_img('img-log').innerHTML += `> ${msg}<br>`; I_img('img-log').scrollTop = I_img('img-log').scrollHeight; }
    
    I_img('img-quality').oninput = (e) => I_img('img-val').innerText = e.target.value;
    I_img('img-drop').onclick = () => I_img('img-in').click();
    I_img('img-in').onchange = (e) => {
        imgFiles = Array.from(e.target.files);
        if(imgFiles.length>0) { I_img('img-log').innerHTML=''; logImg(`é€‰å®š ${imgFiles.length} å¼ `); I_img('img-btn').disabled=false; I_img('img-btn').innerText=`å¼€å§‹ (${imgFiles.length})`; }
    };
    I_img('img-btn').onclick = async () => {
        const zip = new JSZip();
        I_img('img-btn').disabled=true; I_img('img-res').style.display='none';
        for(let i=0; i<imgFiles.length; i++) {
            const f = imgFiles[i];
            logImg(`å¤„ç†: ${f.name}...`);
            try {
                const blob = await compressImg(f, I_img('img-quality').value/100, I_img('img-width').value, I_img('img-fmt').value);
                const saved = ((f.size-blob.size)/f.size*100).toFixed(1);
                logImg(`<span style="color:#00ff00">âœ… æˆåŠŸ (çœ${saved}%)</span>`);
                let ext = I_img('img-fmt').value.split('/')[1].replace('jpeg','jpg');
                zip.file(f.name.replace(/\.[^/.]+$/, "")+`_opt.${ext}`, blob);
            } catch(e) { logImg(`<span style="color:red">âŒ å¤±è´¥</span>`); }
        }
        I_img('img-count').innerText=imgFiles.length; I_img('img-res').style.display='block';
        I_img('img-dl').onclick = async () => saveAs(await zip.generateAsync({type:"blob"}), "images_opt.zip");
        I_img('img-btn').disabled=false; I_img('img-btn').innerText="å†æ¬¡å‹ç¼©";
    };
    function compressImg(file, q, w, fmt) {
        return new Promise((res, rej) => {
            const r = new FileReader(); r.readAsDataURL(file);
            r.onload = e => {
                const img = new Image(); img.src = e.target.result;
                img.onload = () => {
                    const c = document.createElement('canvas');
                    let rw=img.width, rh=img.height;
                    if(w>0 && rw>w) { rh=Math.round(rh*(w/rw)); rw=w; }
                    c.width=rw; c.height=rh;
                    c.getContext('2d').drawImage(img,0,0,rw,rh);
                    c.toBlob(b=>res(b), fmt, q);
                };
            };
        });
    }

    // --- è§†é¢‘é€»è¾‘ (v0.11 å®šåˆ¶ç‰ˆ) ---
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ 
        log: true, 
        corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js' 
    });

    const I = (id) => document.getElementById(id);
    let vidFile = null, vidMeta = {};
    function logVid(msg) { I('vid-log').innerHTML += `> ${msg}<br>`; I('vid-log').scrollTop = I('vid-log').scrollHeight; }

    (async () => {
        try {
            await ffmpeg.load();
            I('vid-log').innerHTML = "âœ… å¼•æ“åŠ è½½æˆåŠŸ (v5.3)<br>> é»˜è®¤å‚æ•°å·²åº”ç”¨: 1080p, CRF 25, Veryfast";
        } catch(e) {
            I('vid-log').innerHTML = `<span style="color:red">âŒ åŠ è½½å¤±è´¥: ${e.message}</span>`;
        }
    })();

    I('vid-drop').onclick = () => I('vid-in').click();
    I('vid-in').onchange = (e) => {
        vidFile = e.target.files[0];
        if(!vidFile) return;
        I('vid-lbl').innerText = vidFile.name;
        const v = document.createElement('video');
        v.src = URL.createObjectURL(vidFile);
        v.onloadedmetadata = () => { vidMeta.dur = v.duration; I('vid-btn').disabled = false; };
    };
    I('vid-mode').onchange = (e) => { I('crf-box').style.display = e.target.value==='crf'?'block':'none'; I('tgt-box').style.display = e.target.value==='target'?'block':'none'; };
    I('vid-crf').oninput = (e) => I('crf-val').innerText = e.target.value;

    I('vid-btn').onclick = async () => {
        if(!ffmpeg.isLoaded() || !vidFile) return;
        I('vid-btn').disabled=true; I('vid-res-area').style.display='none';
        I('vid-prog').style.width='0%';
        logVid("å†™å…¥å†…å­˜...");
        
        try {
            ffmpeg.FS('writeFile', 'in.mp4', await fetchFile(vidFile));
            
            // ç¼–ç å™¨åˆ¤æ–­
            const codec = I('vid-codec').value;
            let args = ['-i', 'in.mp4', '-c:v', codec];
            
            // é¢„è®¾å‚æ•°
            args.push('-preset', I('vid-pre').value);
            
            // åˆ†è¾¨ç‡
            if(I('vid-res').value === '720p') args.push('-vf', 'scale=-2:720');
            if(I('vid-res').value === '1080p') args.push('-vf', 'scale=-2:1080');

            // æ¨¡å¼åˆ¤æ–­
            if(I('vid-mode').value === 'target') {
                const tgt = parseFloat(I('vid-tgt').value);
                const br = Math.floor((tgt * 8388608 / vidMeta.dur) - (I('vid-aud').value*1000));
                args.push('-b:v', `${Math.max(br, 50000)}`);
            } else {
                args.push('-crf', I('vid-crf').value);
            }
            
            args.push('-c:a', 'aac', '-b:a', `${I('vid-aud').value}k`, 'out.mp4');

            logVid(`ğŸš€ å¼€å§‹è½¬ç ... (ä½¿ç”¨ ${I('vid-pre').value})`);
            logVid(`âš  æç¤º: Veryfast æ¨¡å¼ä¸‹è¿›åº¦æ¡å¯èƒ½æ›´æ–°è¾ƒæ…¢ï¼Œè¯·è€å¿ƒç­‰å¾…...`);
            
            ffmpeg.setProgress(({ ratio }) => {
                const p = Math.round(ratio * 100);
                if(p>0 && p<=100) { I('vid-prog').style.width = `${p}%`; I('vid-prog').innerText = `${p}%`; }
            });

            const t1 = Date.now();
            await ffmpeg.run(...args);
            const t2 = Date.now();
            logVid(`âœ… å®Œæˆ! è€—æ—¶: ${((t2-t1)/1000).toFixed(1)}s`);

            const data = ffmpeg.FS('readFile', 'out.mp4');
            const url = URL.createObjectURL(new Blob([data.buffer], {type: 'video/mp4'}));
            I('orig-size').innerText = (vidFile.size/1024/1024).toFixed(1)+"MB";
            I('new-size').innerText = (data.byteLength/1024/1024).toFixed(1)+"MB";
            I('saved-pct').innerText = "èŠ‚çœ " + ((vidFile.size - data.byteLength)/vidFile.size*100).toFixed(1) + "%";
            I('vid-dl').href = url; I('vid-dl').download = `compressed_${vidFile.name}`;
            I('vid-res-area').style.display = 'block';
        } catch(e) {
            logVid(`âŒ é”™è¯¯: ${e.message}`);
            // å¦‚æœæ˜¯å› ä¸º H.265 æŠ¥é”™ï¼Œç»™å‡ºæç¤º
            if(I('vid-codec').value === 'libx265') {
                logVid("âš  æç¤º: å½“å‰ Web å¼•æ“å¯èƒ½ä¸æ”¯æŒ H.265ï¼Œè¯·åˆ‡æ¢å› H.264 é‡è¯•ã€‚");
            }
        } finally { I('vid-btn').disabled = false; }
    };
</script>
</body>
</html>
