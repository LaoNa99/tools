<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halo Media Tool (Vercel Edition)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.7/dist/umd/ffmpeg.js"></script>
    <script src="https://unpkg.com/@ffmpeg/util@0.12.1/dist/umd/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        body { background-color: #f0f2f5; font-family: "Microsoft YaHei UI", sans-serif; }
        .main-container { max-width: 980px; margin: 30px auto; background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); overflow: hidden; }
        .header { background: #000; color: white; padding: 20px; } /* Vercel é£æ ¼é»‘ */
        .nav-tabs .nav-link { color: #495057; font-weight: 600; padding: 15px 25px; cursor: pointer; }
        .nav-tabs .nav-link.active { color: #000; border-bottom: 3px solid #000; }
        .tab-content { padding: 25px; }
        
        /* æ‹–æ‹½åŒºæ ·å¼ */
        .drop-zone { border: 2px dashed #adb5bd; background: #f8f9fa; padding: 30px; text-align: center; cursor: pointer; border-radius: 8px; transition: 0.3s; }
        .drop-zone:hover { border-color: #000; background: #e9ecef; }
        
        /* æ—¥å¿—åŒºæ ·å¼ (æ¢å¤æ—§ç‰ˆ) */
        .log-box { 
            background: #212529; color: #00ff00; 
            font-family: Consolas, monospace; font-size: 0.85rem; 
            height: 180px; overflow-y: auto; padding: 10px; 
            border-radius: 6px; margin-top: 15px; 
            white-space: pre-wrap;
        }
        .param-group { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #dee2e6; }
    </style>
</head>
<body>

<div class="main-container">
    <div class="header d-flex justify-content-between align-items-center">
        <h4 class="m-0">Halo Media Tool <span class="badge bg-light text-dark" style="font-size:0.6em">Multi-Threaded</span></h4>
        <small>Powered by Vercel</small>
    </div>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="img-tab" data-bs-toggle="tab" data-bs-target="#img-pane" type="button">ğŸ–¼ï¸ å›¾ç‰‡å‹ç¼©</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="video-tab" data-bs-toggle="tab" data-bs-target="#video-pane" type="button">ğŸ¬ è§†é¢‘å‹ç¼©</button>
        </li>
    </ul>

    <div class="tab-content">
        
        <div class="tab-pane fade show active" id="img-pane" role="tabpanel">
            <div class="row">
                <div class="col-md-5">
                    <div class="param-group">
                        <label class="form-label fw-bold">å›¾ç‰‡å‚æ•°</label>
                        <div class="mb-3">
                            <label>è´¨é‡ (5-100)</label>
                            <div class="d-flex align-items-center">
                                <input type="range" class="form-range flex-grow-1" id="img-quality" min="5" max="100" value="75">
                                <span class="badge bg-secondary ms-2" id="img-val">75</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label>æœ€å¤§å®½åº¦ (px, 0=ä¸ç¼©æ”¾)</label>
                            <input type="number" class="form-control" id="img-width" value="0" placeholder="ä¾‹å¦‚: 1920">
                        </div>
                        <div class="mb-3">
                            <label>è¾“å‡ºæ ¼å¼</label>
                            <select class="form-select" id="img-fmt">
                                <option value="image/jpeg">JPEG (é»˜è®¤)</option>
                                <option value="image/png">PNG</option>
                                <option value="image/webp">WEBP</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="col-md-7">
                    <div class="drop-zone" id="img-drop">
                        <h5>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œ</h5>
                        <p class="text-muted small">æ”¯æŒ JPG, PNG, WEBP (å¯å¤šé€‰)</p>
                        <input type="file" id="img-in" accept="image/*" multiple style="display:none">
                    </div>
                    
                    <button id="img-btn" class="btn btn-success w-100 mt-3" disabled>å¼€å§‹å‹ç¼©</button>

                    <div id="img-res" class="mt-3" style="display:none;">
                        <div class="alert alert-success d-flex justify-content-between align-items-center py-2">
                            <span>å¤„ç†å®Œæˆ: <b id="img-count">0</b> å¼ </span>
                            <button id="img-dl" class="btn btn-sm btn-outline-success" style="background:white;">ğŸ“¦ æ‰“åŒ…ä¸‹è½½ (ZIP)</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="log-box" id="img-log">ç­‰å¾…é€‰æ‹©å›¾ç‰‡...</div>
        </div>

        <div class="tab-pane fade" id="video-pane" role="tabpanel">
            <div class="alert alert-info py-2 small">
                <i class="bi bi-lightning-charge-fill"></i> 
                <strong>æé€Ÿæ¨¡å¼ï¼š</strong> å¤šçº¿ç¨‹åŠ é€Ÿå·²å¯ç”¨ã€‚ä¾èµ– Vercel é«˜æ€§èƒ½ç¯å¢ƒã€‚
            </div>

            <div class="drop-zone py-4" id="vid-drop">
                <h5 class="mb-1">ğŸ“‚ ç‚¹å‡»é€‰æ‹©è§†é¢‘æ–‡ä»¶</h5>
                <p class="text-muted small mb-0" id="vid-lbl">æœªé€‰æ‹©æ–‡ä»¶</p>
                <input type="file" id="vid-in" accept="video/*" style="display:none">
            </div>

            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="param-group">
                        <label class="fw-bold">æ¨¡å¼é€‰æ‹©</label>
                        <select class="form-select mb-2" id="vid-mode">
                            <option value="crf">CRF ç”»è´¨ä¼˜å…ˆ (é»˜è®¤)</option>
                            <option value="target">ç›®æ ‡å¤§å°ä¼˜å…ˆ</option>
                        </select>
                        
                        <div id="crf-box">
                            <label class="small text-muted">CRF å€¼ (18-35): <span id="crf-val" class="text-primary fw-bold">28</span></label>
                            <input type="range" class="form-range" id="vid-crf" min="18" max="35" value="28">
                        </div>

                        <div id="tgt-box" style="display:none;">
                            <label class="small text-muted">ç›®æ ‡å¤§å° (MB)</label>
                            <input type="number" class="form-control" id="vid-tgt" placeholder="ä¾‹å¦‚: 50">
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="param-group">
                        <label class="fw-bold">é«˜çº§è®¾ç½®</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="small text-muted">åˆ†è¾¨ç‡</label>
                                <select class="form-select form-select-sm" id="vid-res">
                                    <option value="orig">åŸå§‹</option>
                                    <option value="720p">720p</option>
                                    <option value="1080p">1080p</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="small text-muted">é¢„è®¾é€Ÿåº¦</label>
                                <select class="form-select form-select-sm" id="vid-pre">
                                    <option value="veryfast" selected>Veryfast</option>
                                    <option value="ultrafast">Ultrafast (æœ€å¿«)</option>
                                    <option value="medium">Medium (è¾ƒæ…¢)</option>
                                </select>
                            </div>
                            <div class="col-12 mt-2">
                                <label class="small text-muted">éŸ³é¢‘ç ç‡ (kbps)</label>
                                <input type="number" class="form-control form-control-sm" id="vid-aud" value="128">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <button id="vid-btn" class="btn btn-primary w-100 py-2" disabled>å¼€å§‹è§†é¢‘å‹ç¼©</button>
            
            <div class="progress mt-3" style="height: 25px;">
                <div id="vid-prog" class="progress-bar progress-bar-striped progress-bar-animated bg-success" style="width: 0%">0%</div>
            </div>

            <div class="log-box mt-3" id="vid-log">ç³»ç»Ÿæ­£åœ¨åˆå§‹åŒ–å¤šçº¿ç¨‹å¼•æ“ (v0.12)...</div>

            <div id="vid-res-area" class="mt-3 text-center" style="display:none;">
                <h5 class="text-success">âœ… è§†é¢‘å‹ç¼©å®Œæˆ</h5>
                <p>å‹ç¼©å‰: <b id="orig-size"></b> -> å‹ç¼©å: <b id="new-size"></b> (<span id="saved-pct"></span>)</p>
                <a id="vid-dl" class="btn btn-success">â¬‡ï¸ ä¸‹è½½è§†é¢‘</a>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ================= å›¾ç‰‡é€»è¾‘ (æ¢å¤æ»šåŠ¨æ—¥å¿—) =================
    const I = (id) => document.getElementById(id);
    let imgFiles = [];

    // æ—¥å¿—å‡½æ•° (è¿½åŠ æ¨¡å¼)
    function logImg(msg) {
        I('img-log').innerHTML += `> ${msg}<br>`;
        I('img-log').scrollTop = I('img-log').scrollHeight;
    }

    I('img-quality').oninput = (e) => I('img-val').innerText = e.target.value;
    
    I('img-drop').onclick = () => I('img-in').click();
    I('img-in').onchange = (e) => {
        imgFiles = Array.from(e.target.files);
        if(imgFiles.length > 0) {
            I('img-log').innerHTML = ''; // æ¸…ç©ºæ—§æ—¥å¿—
            logImg(`å·²é€‰æ‹© ${imgFiles.length} å¼ å›¾ç‰‡ã€‚`);
            I('img-btn').disabled = false;
            I('img-btn').innerText = `å¼€å§‹å‹ç¼© (${imgFiles.length}å¼ )`;
        }
    };

    I('img-btn').onclick = async () => {
        const quality = I('img-quality').value / 100;
        const width = I('img-width').value;
        const fmt = I('img-fmt').value;
        const zip = new JSZip();

        I('img-btn').disabled = true;
        I('img-res').style.display = 'none';
        logImg("=== å¼€å§‹æ‰¹é‡å¤„ç† ===");

        for (let i = 0; i < imgFiles.length; i++) {
            const f = imgFiles[i];
            logImg(`æ­£åœ¨å¤„ç† (${i+1}/${imgFiles.length}): ${f.name}...`);
            try {
                const blob = await compressImg(f, quality, width, fmt);
                const saved = ((f.size - blob.size) / f.size * 100).toFixed(1);
                
                // æˆåŠŸçš„ç»¿è‰²æ—¥å¿—
                logImg(`<span style="color:#00ff00">âœ… æˆåŠŸ: ${(blob.size/1024).toFixed(1)}KB (èŠ‚çœ ${saved}%)</span>`);
                
                // åŠ å…¥ ZIP
                let ext = fmt.split('/')[1];
                if(ext==='jpeg') ext='jpg';
                const newName = f.name.substring(0, f.name.lastIndexOf('.')) + `_opt.${ext}`;
                zip.file(newName, blob);
            } catch (err) {
                logImg(`<span style="color:#ff0000">âŒ å¤±è´¥: ${err.message}</span>`);
            }
        }

        logImg("=== å…¨éƒ¨å®Œæˆ ===");
        I('img-count').innerText = imgFiles.length;
        I('img-res').style.display = 'block';
        
        // ç»‘å®šä¸‹è½½
        I('img-dl').onclick = async () => {
            const content = await zip.generateAsync({type:"blob"});
            saveAs(content, "images_optimized.zip");
        };
        I('img-btn').disabled = false;
        I('img-btn').innerText = "å†æ¬¡å‹ç¼©";
    };

    function compressImg(file, q, w, fmt) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = e => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const c = document.createElement('canvas');
                    let rw = img.width, rh = img.height;
                    if(w > 0 && rw > w) { rh = Math.round(rh * (w/rw)); rw = w; }
                    c.width = rw; c.height = rh;
                    const ctx = c.getContext('2d');
                    ctx.drawImage(img, 0, 0, rw, rh);
                    c.toBlob(blob => {
                        if(blob) resolve(blob); else reject(new Error("Canvasé”™è¯¯"));
                    }, fmt, q);
                };
                img.onerror = err => reject(err);
            };
        });
    }

    // ================= è§†é¢‘é€»è¾‘ (FFmpeg v0.12 å¤šçº¿ç¨‹) =================
    const { FFmpeg } = FFmpegWASM;
    const { fetchFile } = FFmpegUtil;
    let ffmpeg = null;
    let vidFile = null;
    let vidMeta = {};

    function logVid(msg) {
        I('vid-log').innerHTML += `> ${msg}<br>`;
        I('vid-log').scrollTop = I('vid-log').scrollHeight;
    }

    const initFFmpeg = async () => {
        ffmpeg = new FFmpeg();
        ffmpeg.on('log', ({ message }) => {
            // è¿‡æ»¤ä¸€äº›æ— ç”¨çš„FFmpegå†…éƒ¨æ—¥å¿—ï¼Œåªæ˜¾ç¤ºå…³é”®ä¿¡æ¯
            if(message.includes('frame=') || message.includes('size=')) {
                // è¿™ç§æ—¥å¿—å¤ªå¤šï¼Œä¸æ˜¾ç¤ºåœ¨ logBoxï¼Œåªåœ¨æ§åˆ¶å°
                console.log(message); 
            } else {
                // logVid(message); // å¦‚æœè§‰å¾—æ—¥å¿—å¤ªä¹±ï¼Œå¯ä»¥æ³¨é‡Šæ‰è¿™è¡Œ
            }
        });
        ffmpeg.on('progress', ({ progress }) => {
            const p = Math.round(progress * 100);
            if(p > 0 && p <= 100) {
                I('vid-prog').style.width = `${p}%`;
                I('vid-prog').innerText = `${p}%`;
            }
        });

        try {
            await ffmpeg.load({
                coreURL: 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.js',
                wasmURL: 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.wasm',
            });
            I('vid-log').innerHTML = "âœ… å¤šçº¿ç¨‹å¼•æ“åŠ è½½æˆåŠŸï¼<br>> è¯·ä¸Šä¼ è§†é¢‘å¼€å§‹å‹ç¼©ã€‚";
        } catch (e) {
            I('vid-log').innerHTML = `<span style="color:red">âŒ å¼•æ“åŠ è½½å¤±è´¥: ${e.message}</span><br>è¯·æ£€æŸ¥ vercel.json æ˜¯å¦é…ç½®æ­£ç¡®ã€‚`;
        }
    };
    initFFmpeg(); // å¯åŠ¨åŠ è½½

    // UI äº¤äº’
    I('vid-drop').onclick = () => I('vid-in').click();
    I('vid-in').onchange = (e) => {
        vidFile = e.target.files[0];
        if(!vidFile) return;
        I('vid-lbl').innerText = vidFile.name;
        
        // è·å–æ—¶é•¿
        const v = document.createElement('video');
        v.preload = 'metadata';
        v.src = URL.createObjectURL(vidFile);
        v.onloadedmetadata = () => {
            vidMeta.duration = v.duration;
            logVid(`å·²åŠ è½½: ${vidFile.name} (æ—¶é•¿: ${v.duration.toFixed(1)}s)`);
            I('vid-btn').disabled = false;
        };
    };

    I('vid-mode').onchange = (e) => {
        I('crf-box').style.display = e.target.value === 'crf' ? 'block' : 'none';
        I('tgt-box').style.display = e.target.value === 'target' ? 'block' : 'none';
    };
    I('vid-crf').oninput = (e) => I('crf-val').innerText = e.target.value;

    I('vid-btn').onclick = async () => {
        if(!ffmpeg || !vidFile) return;
        I('vid-btn').disabled = true;
        I('vid-res-area').style.display = 'none';
        I('vid-prog').style.width = '0%';
        logVid("æ­£åœ¨å°†è§†é¢‘å†™å…¥å†…å­˜...");

        try {
            await ffmpeg.writeFile('input.mp4', await fetchFile(vidFile));
            
            let args = ['-i', 'input.mp4', '-c:v', 'libx264', '-preset', I('vid-pre').value];
            
            // åˆ†è¾¨ç‡å¤„ç†
            const res = I('vid-res').value;
            if(res === '720p') args.push('-vf', 'scale=-2:720');
            if(res === '1080p') args.push('-vf', 'scale=-2:1080');

            // æ¨¡å¼å¤„ç†
            if(I('vid-mode').value === 'target') {
                const tgt = parseFloat(I('vid-tgt').value);
                if(!tgt) throw new Error("è¯·è¾“å…¥æœ‰æ•ˆçš„ç›®æ ‡å¤§å°");
                const bitrate = Math.floor((tgt * 8388608 / vidMeta.duration) - (I('vid-aud').value * 1000));
                args.push('-b:v', `${Math.max(bitrate, 50000)}`); // æœ€å°ä¿æŠ¤
                logVid(`ç›®æ ‡æ¨¡å¼: é™åˆ¶è§†é¢‘ç ç‡ä¸º ${Math.floor(bitrate/1000)}k`);
            } else {
                args.push('-crf', I('vid-crf').value);
            }

            args.push('-c:a', 'aac', '-b:a', `${I('vid-aud').value}k`);
            args.push('output.mp4');

            logVid("ğŸš€ å¼€å§‹å¤šçº¿ç¨‹æé€Ÿè½¬ç ...");
            const startTime = Date.now();
            
            await ffmpeg.exec(args);
            
            const duration = (Date.now() - startTime) / 1000;
            logVid(`âœ… è½¬ç å®Œæˆ! è€—æ—¶: ${duration.toFixed(1)}ç§’`);

            const data = await ffmpeg.readFile('output.mp4');
            const blob = new Blob([data.buffer], {type: 'video/mp4'});
            const url = URL.createObjectURL(blob);

            // æ˜¾ç¤ºç»“æœ
            I('orig-size').innerText = (vidFile.size/1024/1024).toFixed(1) + "MB";
            I('new-size').innerText = (blob.size/1024/1024).toFixed(1) + "MB";
            I('saved-pct').innerText = "èŠ‚çœ " + ((vidFile.size - blob.size)/vidFile.size*100).toFixed(1) + "%";
            
            I('vid-dl').href = url;
            I('vid-dl').download = `compressed_${vidFile.name}`;
            I('vid-res-area').style.display = 'block';

        } catch (err) {
            logVid(`âŒ é”™è¯¯: ${err.message}`);
            console.error(err);
        } finally {
            I('vid-btn').disabled = false;
        }
    };
</script>
</body>
</html>
